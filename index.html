<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TG Mini App — Debug</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body {
      margin: 0;
      padding: 16px;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #111);
      visibility: hidden;
    }
    body.ready { visibility: visible; }

    h1 { margin: 0 0 12px; font-size: 18px; }

    .card {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.25);
      background: rgba(127,127,127,.08);
      margin-bottom: 12px;
    }

    .params-title { font-weight: 700; margin-bottom: 10px; }
    .param { margin: 8px 0; }
    .param strong { font-weight: 750; }

    summary {
      cursor: pointer;
      font-weight: 650;
      list-style: none;
      outline: none;
    }
    summary::-webkit-details-marker { display: none; }
    summary::before {
      content: "▶";
      display: inline-block;
      margin-right: 8px;
      transform-origin: center;
      transition: transform .12s ease;
      opacity: .85;
    }
    details[open] summary::before { transform: rotate(90deg); }
    .content { margin-top: 10px; }

    pre {
      margin: 0;
      overflow: auto;
      padding: 10px;
      border-radius: 10px;
      background: rgba(0,0,0,.10);
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    (function () {
      function getUrlCustomParams() {
        const q = new URLSearchParams(location.search);
        const obj = {};
        for (const [k, v] of q.entries()) {
          if (/^tgwebapp/i.test(k)) continue;
          obj[k] = v;
        }
        return obj;
      }

      function parseStartParam(startParam) {
        if (!startParam) return {};
        const raw = String(startParam).trim();
        if (!raw) return {};
        const parts = raw.split("__").filter(Boolean);
        const params = {};
        for (const part of parts) {
          const p = part.trim();
          if (!p) continue;
          const dash = p.indexOf("-");
          if (dash <= 0) continue;
          const key = p.slice(0, dash).trim();
          let value = p.slice(dash + 1).trim();
          value = value.replace(/--/g, "-");
          if (key) params[key] = value;
        }
        return params;
      }

      function mergeParams(startParams, urlParams) {
        return { ...startParams, ...urlParams };
      }

      function normalizeChannelName(raw) {
        if (!raw) return null;
        let s = String(raw).trim();
        if (s.startsWith("@")) s = s.slice(1);
        if (!/^[A-Za-z0-9_]{5,32}$/.test(s)) return null;
        return s;
      }

      const tg = window.Telegram?.WebApp ?? null;

      const startParam = tg?.initDataUnsafe?.start_param ?? null;
      const startParams = parseStartParam(startParam);
      const urlParams = getUrlCustomParams();
      const params = mergeParams(startParams, urlParams);

      let redirectTo = null;
      if (params.channel != null) {
        const ch = normalizeChannelName(params.channel);
        if (ch) redirectTo = `https://t.me/${ch}`;
      }

      window.__BOOT__ = { params, redirectTo };

      if (redirectTo) {
        try { tg?.ready?.(); } catch {}
        if (tg?.openTelegramLink) {
          tg.openTelegramLink(redirectTo);
          setTimeout(() => tg.close?.(), 250);
        } else {
          location.replace(redirectTo);
        }
      }
    })();
  </script>
</head>

<body>
  <h1>Telegram Mini App — Debug</h1>

  <div class="card">
    <div class="params-title">Параметры ссылки:</div>
    <div id="paramsText"></div>
  </div>

  <div class="card">
    <details>
      <summary>1) InitData (unsafe)</summary>
      <div class="content"><pre id="unsafeDump"></pre></div>
    </details>
  </div>

  <div class="card">
    <details>
      <summary>2) InitData (raw)</summary>
      <div class="content"><pre id="initDataDump"></pre></div>
    </details>
  </div>

  <div class="card">
    <details>
      <summary>3) Telegram WebApp</summary>
      <div class="content"><pre id="baseDump"></pre></div>
    </details>
  </div>

  <script>
    function safeJson(obj) {
      try { return JSON.stringify(obj, null, 2); }
      catch { return String(obj); }
    }

    function renderParamsText(params) {
      const el = document.getElementById("paramsText");
      const keys = Object.keys(params || {});
      if (keys.length === 0) {
        el.textContent = "(нет)";
        return;
      }
      el.innerHTML = "";
      keys.sort().forEach((k) => {
        const row = document.createElement("div");
        row.className = "param";

        const keyEl = document.createElement("strong");
        keyEl.textContent = k;

        const sep = document.createTextNode(": ");

        const valEl = document.createElement("span");
        valEl.textContent = String(params[k]);

        row.appendChild(keyEl);
        row.appendChild(sep);
        row.appendChild(valEl);
        el.appendChild(row);
      });
    }

    function dump() {
      const boot = window.__BOOT__ || { params: {}, redirectTo: null };
      if (boot.redirectTo) return;

      const tg = window.Telegram?.WebApp ?? null;
      try { tg?.ready?.(); } catch {}

      renderParamsText(boot.params);

      if (!tg) {
        document.getElementById("unsafeDump").textContent = "";
        document.getElementById("initDataDump").textContent = "";
        document.getElementById("baseDump").textContent =
          "Telegram.WebApp недоступен (открой страницу внутри Telegram Mini App).";
        document.body.classList.add("ready");
        return;
      }

      document.getElementById("unsafeDump").textContent = safeJson(tg.initDataUnsafe);
      document.getElementById("initDataDump").textContent = tg.initData || "(empty)";

      const base = {
        version: tg.version,
        platform: tg.platform,
        colorScheme: tg.colorScheme,
        isExpanded: tg.isExpanded,
        initDataPresent: Boolean(tg.initData),
        initDataLength: tg.initData?.length ?? 0
      };
      document.getElementById("baseDump").textContent = safeJson(base);

      document.body.classList.add("ready");
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", dump, { once: true });
    } else {
      dump();
    }
  </script>
</body>
</html>
